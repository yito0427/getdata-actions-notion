name: Sync Notion Database to GitHub

on:
  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      auto_commit:
        description: 'è‡ªå‹•ã§ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥ã‚’å®Ÿè¡Œã™ã‚‹'
        required: false
        default: 'true'
        type: choice
        options:
        - 'true'
        - 'false'
  
  # é€±1å›è‡ªå‹•å®Ÿè¡Œï¼ˆæ—¥æ›œæ—¥ 09:00 JSTï¼‰
  schedule:
    - cron: '0 0 * * 0'  # UTC 00:00 = JST 09:00

jobs:
  sync-notion-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Pythonç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Poetry ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        curl -sSL https://install.python-poetry.org | python3 -
        echo "$HOME/.local/bin" >> $GITHUB_PATH
    
    - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        poetry install --no-root
    
    - name: Notionã‹ã‚‰GitHubã¸ã®åŒæœŸå®Ÿè¡Œ
      env:
        NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
        NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        LOG_LEVEL: INFO
      run: |
        poetry run python scripts/github-sync/export_notion_to_github.py
    
    - name: å¤‰æ›´ã®ç¢ºèª
      id: check_changes
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:"
          git status --porcelain
        else
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“"
        fi
    
    - name: Gitã‚³ãƒŸãƒƒãƒˆã¨ãƒ—ãƒƒã‚·ãƒ¥
      if: steps.check_changes.outputs.changes == 'true' && (github.event.inputs.auto_commit == 'true' || github.event_name == 'schedule')
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add docs/exchange-data/
        git add output/ || true
        
        # ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ä»˜ãã®ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S JST')
        git commit -m "update: Notionãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— ($TIMESTAMP)

        ğŸ¤– Generated with [Claude Code](https://claude.ai/code)

        Co-Authored-By: Claude <noreply@anthropic.com>"
        
        git push
    
    - name: å®Ÿè¡Œçµæœã®ã‚µãƒãƒªãƒ¼
      run: |
        echo "## ğŸ‰ NotionåŒæœŸå®Œäº†" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**å®Ÿè¡Œæ™‚åˆ»**: $(date '+%Y-%m-%d %H:%M:%S JST')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.check_changes.outputs.changes }}" == "true" ]; then
          echo "âœ… **å¤‰æ›´ã‚’æ¤œå‡º**: ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          
          # ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®æƒ…å ±
          if [ -f "docs/exchange-data/exchange-survey-results.md" ]; then
            echo "- ğŸ“„ [æœ€æ–°èª¿æŸ»çµæœ](docs/exchange-data/exchange-survey-results.md)" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f "docs/exchange-data/latest-survey-data.json" ]; then
            echo "- ğŸ“Š [JSONãƒ‡ãƒ¼ã‚¿](docs/exchange-data/latest-survey-data.json)" >> $GITHUB_STEP_SUMMARY
          fi
          
          # å±¥æ­´ãƒ•ã‚¡ã‚¤ãƒ«
          LATEST_HISTORY=$(ls -t docs/exchange-data/history/survey_*.md 2>/dev/null | head -1 || echo "")
          if [ -n "$LATEST_HISTORY" ]; then
            echo "- ğŸ“š [å±¥æ­´ãƒ•ã‚¡ã‚¤ãƒ«]($LATEST_HISTORY)" >> $GITHUB_STEP_SUMMARY
          fi
          
        else
          echo "â„¹ï¸ **å¤‰æ›´ãªã—**: Notionãƒ‡ãƒ¼ã‚¿ã«æ›´æ–°ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ" >> $GITHUB_STEP_SUMMARY
        fi