name: ğŸ§ª Test Crypto Data Collection

on:
  # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã«ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'pyproject.toml'
      - '.github/workflows/**'
  
  # æ‰‹å‹•ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      test_exchanges:
        description: 'Exchanges to test (comma-separated)'
        required: false
        default: 'binance,coinbase'
        type: string

jobs:
  test-data-collection:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    strategy:
      matrix:
        python-version: ['3.9', '3.11']
        test-scenario:
          - name: 'Basic Test'
            args: '--test --limit 2'
          - name: 'Priority Exchanges'
            args: '--test --exchanges binance,coinbase,kraken --limit 3'
          - name: 'Single Exchange Deep Test'
            args: '--test --exchanges binance --limit 1'
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: ğŸ“¦ Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true
        
    - name: ğŸ”§ Cache Poetry dependencies
      uses: actions/cache@v3
      with:
        path: .venv
        key: poetry-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('**/poetry.lock') }}
        restore-keys: |
          poetry-${{ runner.os }}-${{ matrix.python-version }}-
          
    - name: ğŸ“š Install dependencies
      run: poetry install --with=dev
      
    - name: ğŸ” Run linting
      run: |
        poetry run flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics
        poetry run mypy src/ --ignore-missing-imports
        
    - name: ğŸ§ª Run unit tests
      run: poetry run pytest tests/ -v --cov=src --cov-report=xml
      
    - name: ğŸŒ Test crypto data collection - ${{ matrix.test-scenario.name }}
      run: |
        echo "Testing: ${{ matrix.test-scenario.name }}"
        poetry run python -m src.main ${{ matrix.test-scenario.args }}
        
    - name: ğŸ“Š Validate output files
      run: |
        # Check if output directory was created
        if [ -d "output" ]; then
          echo "âœ… Output directory created"
          ls -la output/
          
          # Validate JSON output format
          for file in output/*.json; do
            if [ -f "$file" ]; then
              echo "Validating $file"
              python -m json.tool "$file" > /dev/null && echo "âœ… Valid JSON" || echo "âŒ Invalid JSON"
            fi
          done
        else
          echo "âŒ No output directory found"
          exit 1
        fi
        
    - name: ğŸ“ˆ Upload test results
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.python-version }}-${{ matrix.test-scenario.name }}
        path: |
          output/
          coverage.xml
        retention-days: 3
        
    - name: ğŸ“‹ Log test summary
      if: github.event_name == 'pull_request'
      run: |
        echo "## ğŸ§ª Test Results - ${{ matrix.test-scenario.name }} (Python ${{ matrix.python-version }})"
        echo ""
        if [ -d "output" ]; then
          echo "âœ… Output Files Generated: $(ls output/ | wc -l)"
          echo ""
          for file in output/*.json; do
            if [ -f "$file" ]; then
              echo "ğŸ“Š $(basename "$file"): Test data generated"
            fi
          done
        fi
        echo ""
        echo "ğŸ• Duration: Test completed successfully"

  # Notion APIæ¥ç¶šãƒ†ã‚¹ãƒˆï¼ˆç§˜å¯†æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ï¼‰
  test-notion-connection:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    needs: test-data-collection
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true
        
    - name: ğŸ“š Install dependencies
      run: poetry install --with=dev --no-dev
      
    - name: ğŸ”— Test Notion API connection
      env:
        NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
        NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
      run: |
        if [ -n "$NOTION_API_KEY" ] && [ -n "$NOTION_DATABASE_ID" ]; then
          echo "ğŸ” Testing Notion API connection..."
          poetry run python -c "
          import asyncio
          from notion_client import AsyncClient
          
          async def test_connection():
              try:
                  client = AsyncClient(auth='$NOTION_API_KEY')
                  # Test API connection
                  me = await client.users.me()
                  print(f'âœ… Connected as: {me[\"name\"]}')
                  
                  # Test database access
                  db = await client.databases.retrieve('$NOTION_DATABASE_ID')
                  print(f'âœ… Database access: {db[\"title\"][0][\"plain_text\"]}')
                  
              except Exception as e:
                  print(f'âŒ Connection failed: {e}')
                  return False
              return True
              
          result = asyncio.run(test_connection())
          exit(0 if result else 1)
          "
        else
          echo "âš ï¸ Notion credentials not configured - skipping connection test"
        fi